<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>구매 품목 카탈로그</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    :root {
      --bg1: #050816;
      --bg2: #141b2d;
      --accent: #3b82f6;
      --accent-soft: rgba(59,130,246,0.15);
      --accent-strong: #22c55e;
      --text-main: #e5e7eb;
      --text-muted: #9ca3af;
      --border-subtle: rgba(148,163,184,0.4);
      --danger: #ef4444;
      --radius-lg: 18px;
      --radius-md: 999px;
      --radius-sm: 8px;
      --shadow-soft: 0 18px 40px rgba(15,23,42,0.8);
      --shadow-chip: 0 10px 25px rgba(15,23,42,0.9);
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: radial-gradient(circle at top, #111827 0, #020617 45%, #000 100%);
      color: var(--text-main);
      min-height: 100vh;
      padding: 32px;
    }

    .app {
      max-width: 1200px;
      margin: 0 auto;
    }

    .card {
      background: radial-gradient(circle at top left, #1e293b 0, #020617 55%);
      border-radius: 24px;
      padding: 24px 28px 28px;
      box-shadow: var(--shadow-soft);
      border: 1px solid rgba(148,163,184,0.25);
      backdrop-filter: blur(16px);
    }

    .header-main {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      gap: 16px;
    }

    .title-block h1 {
      font-size: 22px;
      letter-spacing: 0.03em;
    }

    .title-block p {
      margin-top: 4px;
      font-size: 12px;
      color: var(--text-muted);
    }

    .pill {
      display: inline-flex;
      align-items: center;
      padding: 4px 10px;
      border-radius: var(--radius-md);
      border: 1px solid rgba(148,163,184,0.4);
      background: radial-gradient(circle at top, rgba(59,130,246,0.15), rgba(15,23,42,0.9));
      font-size: 11px;
      color: var(--text-muted);
      gap: 6px;
    }

    .pill-dot {
      width: 6px;
      height: 6px;
      border-radius: 999px;
      background: #22c55e;
      box-shadow: 0 0 10px rgba(34,197,94,0.8);
    }

    .controls-row {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 16px;
      flex-wrap: wrap;
    }

    .search-input {
      flex: 1 1 260px;
      min-width: 0;
      border-radius: var(--radius-md);
      border: 1px solid var(--border-subtle);
      background: rgba(15,23,42,0.9);
      color: var(--text-main);
      padding: 8px 13px;
      font-size: 13px;
      outline: none;
      box-shadow: inset 0 0 0 1px rgba(15,23,42,0.7);
    }

    .search-input::placeholder {
      color: rgba(148,163,184,0.8);
    }

    .select {
      border-radius: var(--radius-md);
      border: 1px solid var(--border-subtle);
      background: rgba(15,23,42,0.9);
      color: var(--text-main);
      padding: 8px 24px 8px 10px;
      font-size: 13px;
      outline: none;
    }

    .btn {
      border-radius: var(--radius-md);
      border: 1px solid rgba(148,163,184,0.5);
      background: rgba(15,23,42,0.95);
      color: var(--text-main);
      padding: 7px 14px;
      font-size: 12px;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      cursor: pointer;
      white-space: nowrap;
    }

    .btn:hover {
      border-color: rgba(148,163,184,0.9);
      background: radial-gradient(circle at top, rgba(148,163,184,0.2), rgba(15,23,42,1));
    }

    .btn-primary {
      border-color: rgba(59,130,246,0.8);
      background: radial-gradient(circle at top, var(--accent) 0, #1e293b 55%);
      color: #eff6ff;
    }

    .btn-primary:hover {
      border-color: #93c5fd;
      background: radial-gradient(circle at top, #60a5fa 0, #1e293b 60%);
    }

    .btn-ghost {
      border-style: dashed;
      border-color: rgba(148,163,184,0.6);
      background: rgba(15,23,42,0.7);
      color: var(--text-muted);
    }

    .btn-ghost--danger {
      border-color: rgba(239,68,68,0.8);
      color: #fecaca;
    }

    .section-row {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .tabs {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      margin-bottom: 6px;
    }

    .tab {
      border-radius: var(--radius-md);
      padding: 6px 12px;
      font-size: 12px;
      background: rgba(15,23,42,0.9);
      border: 1px solid rgba(75,85,99,0.9);
      color: var(--text-muted);
      cursor: pointer;
      box-shadow: 0 8px 18px rgba(15,23,42,0.8);
    }

    .tab.active {
      background: radial-gradient(circle at top, var(--accent) 0, #1e293b 55%);
      border-color: #93c5fd;
      color: #eff6ff;
      box-shadow: 0 10px 25px rgba(37,99,235,0.8);
    }

    .status-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 11px;
      color: var(--text-muted);
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 8px;
      font-size: 13px;
    }

    thead {
      background: rgba(15,23,42,0.98);
    }

    thead th {
      text-align: left;
      padding: 10px 10px;
      color: var(--text-muted);
      font-weight: 500;
      border-bottom: 1px solid rgba(55,65,81,0.9);
      white-space: nowrap;
    }

    tbody tr {
      border-bottom: 1px solid rgba(31,41,55,0.9);
      background: radial-gradient(circle at left, rgba(15,23,42,0.8), #020617);
      cursor: pointer;
    }

    tbody tr:hover {
      background: radial-gradient(circle at left, rgba(59,130,246,0.25), #020617);
    }

    tbody td {
      padding: 9px 10px;
      vertical-align: middle;
    }

    .chip {
      display: inline-flex;
      align-items: center;
      border-radius: 999px;
      padding: 3px 9px;
      font-size: 11px;
      color: var(--text-muted);
      background: rgba(15,23,42,0.95);
      border: 1px solid rgba(75,85,99,0.9);
      box-shadow: var(--shadow-chip);
      gap: 4px;
    }

    .chip--accent {
      background: rgba(34,197,94,0.08);
      border-color: rgba(34,197,94,0.7);
      color: #bbf7d0;
    }

    .chip-tag {
      display: inline-flex;
      border-radius: 999px;
      padding: 2px 8px;
      background: rgba(15,23,42,0.9);
      border: 1px solid rgba(75,85,99,0.9);
      font-size: 11px;
      margin-right: 4px;
      margin-bottom: 2px;
      color: var(--text-muted);
    }

    .price {
      font-variant-numeric: tabular-nums;
    }

    .link-btn {
      border-radius: var(--radius-md);
      border: none;
      background: radial-gradient(circle at top, var(--accent-strong) 0, #166534 60%);
      color: #ecfdf5;
      padding: 6px 12px;
      font-size: 12px;
      cursor: pointer;
      box-shadow: 0 10px 24px rgba(22,163,74,0.8);
    }

    .link-btn:hover {
      background: radial-gradient(circle at top, #4ade80 0, #166534 65%);
    }

    .link-btn:disabled {
      opacity: 0.4;
      cursor: default;
      box-shadow: none;
    }

    .admin-toggle {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      font-size: 11px;
      color: var(--text-muted);
    }

    .badge-on {
      border-radius: 999px;
      padding: 2px 8px;
      background: rgba(34,197,94,0.12);
      border: 1px solid rgba(34,197,94,0.6);
      color: #bbf7d0;
      font-size: 10px;
    }

    .badge-off {
      border-radius: 999px;
      padding: 2px 8px;
      background: rgba(31,41,55,0.9);
      border: 1px solid rgba(75,85,99,0.9);
      color: var(--text-muted);
      font-size: 10px;
    }

    .admin-panel {
      position: fixed;
      right: 32px;
      bottom: 32px;
      width: 320px;
      max-width: calc(100% - 32px);
      background: radial-gradient(circle at top left, #020617 0, #020617 55%);
      border-radius: 20px;
      box-shadow: var(--shadow-soft);
      border: 1px solid rgba(148,163,184,0.4);
      padding: 16px 16px 14px;
      display: none;
      z-index: 20;
    }

    .admin-panel.open {
      display: block;
    }

    .admin-panel-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }

    .admin-panel-header h3 {
      font-size: 13px;
    }

    .admin-panel-header span {
      font-size: 11px;
      color: var(--text-muted);
    }

    .admin-field {
      margin-bottom: 8px;
    }

    .admin-field label {
      display: block;
      font-size: 11px;
      color: var(--text-muted);
      margin-bottom: 3px;
    }

    .admin-input, .admin-select, .admin-textarea {
      width: 100%;
      border-radius: 10px;
      border: 1px solid var(--border-subtle);
      background: rgba(15,23,42,0.95);
      color: var(--text-main);
      padding: 6px 9px;
      font-size: 12px;
      outline: none;
    }

    .admin-textarea {
      resize: vertical;
      min-height: 46px;
    }

    .admin-footer {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
      margin-top: 8px;
    }

    .admin-footer .btn {
      flex: 1;
      justify-content: center;
    }

    @media (max-width: 840px) {
      body { padding: 16px; }
      .card { padding: 18px 16px 20px; }
      .header-main { flex-direction: column; align-items: flex-start; }
      .controls-row { flex-direction: column; align-items: stretch; }
      .admin-panel {
        right: 16px;
        left: 16px;
        width: auto;
      }
    }
  </style>
</head>
<body>
  <div class="app">
    <div class="card">
      <div class="header-main">
        <div class="title-block">
          <h1>구매 품목 카탈로그</h1>
          <p>반복 구매 품목을 카테고리별로 정리하고, 링크로 바로 이동해 주문합니다.</p>
        </div>
        <div style="display:flex;flex-direction:column;align-items:flex-end;gap:6px;">
          <div class="pill">
            <span class="pill-dot"></span>
            <span>SharePoint 연결 · 실시간 저장</span>
          </div>
          <label class="admin-toggle">
            <input type="checkbox" id="adminModeToggle" style="margin-right:4px;">
            <span>관리자 모드</span>
            <span id="adminModeBadge" class="badge-off">OFF</span>
          </label>
        </div>
      </div>

      <div class="controls-row">
        <input id="searchInput" class="search-input"
               placeholder="품명·태그 검색 (예: 컵홀더, 회의실, 본사)" />
        <select id="sortSelect" class="select">
          <option value="default">정렬 없음</option>
          <option value="nameAsc">품명 오름차순</option>
          <option value="nameDesc">품명 내림차순</option>
          <option value="priceAsc">금액 낮은순</option>
          <option value="priceDesc">금액 높은순</option>
        </select>
        <button id="refreshBtn" class="btn">
          새로 불러오기
        </button>
      </div>

      <div class="section-row">
        <div id="categoryTabs" class="tabs"></div>

        <div class="status-bar">
          <div>
            <span id="countInfo">총 0개 항목</span>
          </div>
          <div>
            <span style="font-size:10px;color:var(--text-muted);">
              행 클릭 → 관리자 모드시 수정 / 삭제 가능
            </span>
          </div>
        </div>

        <div style="margin-top:4px;overflow:auto;border-radius:16px;border:1px solid rgba(31,41,55,0.9);">
          <table>
            <thead>
              <tr>
                <th style="width:30%;">품명</th>
                <th style="width:12%;">카테고리</th>
                <th style="width:28%;">태그</th>
                <th style="width:12%;text-align:right;">금액(원)</th>
                <th style="width:12%;text-align:center;">링크</th>
              </tr>
            </thead>
            <tbody id="itemsBody"></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- 관리자 패널 -->
  <div id="adminPanel" class="admin-panel">
    <div class="admin-panel-header">
      <div>
        <h3 id="adminTitle">새 품목 추가</h3>
        <span id="adminHint">SharePoint 리스트에 바로 저장됩니다.</span>
      </div>
      <button id="adminCloseBtn" class="btn btn-ghost" style="padding:3px 8px;font-size:11px;">닫기</button>
    </div>

    <div class="admin-field">
      <label for="adminName">품명</label>
      <input id="adminName" class="admin-input" />
    </div>

    <div class="admin-field">
      <label for="adminCategory">카테고리</label>
      <select id="adminCategory" class="admin-select">
        <option value="">선택</option>
        <option value="IT/장비">IT/장비</option>
        <option value="사무용품">사무용품</option>
        <option value="소모품">소모품</option>
        <option value="시설">시설</option>
        <option value="탕비류">탕비류</option>
      </select>
    </div>

    <div class="admin-field">
      <label for="adminPrice">금액 (숫자만, 콤마 없이)</label>
      <input id="adminPrice" type="number" class="admin-input" />
    </div>

    <div class="admin-field">
      <label for="adminUrl">주문 링크 (URL)</label>
      <input id="adminUrl" class="admin-input" />
    </div>

    <div class="admin-field">
      <label for="adminTags">태그 (쉼표 또는 공백으로 구분, 예: 본사, 회의실, 정기구매)</label>
      <textarea id="adminTags" class="admin-textarea"></textarea>
    </div>

    <div class="admin-footer">
      <button id="deleteBtn" class="btn btn-ghost btn-ghost--danger" style="display:none;">삭제</button>
      <div style="display:flex;gap:6px;flex:1;justify-content:flex-end;">
        <button id="resetBtn" class="btn btn-ghost">초기화</button>
        <button id="saveBtn" class="btn btn-primary">저장</button>
      </div>
    </div>
  </div>

  <script>
    // =====================
    // SharePoint 설정
    // =====================
    // ◆ 반드시 이 값만 환경에 맞게 수정해라.
    // 사이트 주소 예: https://xxx.sharepoint.com/sites/bk
    //   -> SP_SITE_RELATIVE_URL = "/sites/bk";
    // 루트 사이트면 그냥 "" 로 둬도 됨.
    const SP_SITE_RELATIVE_URL = "/sites/bk";
    const SP_LIST_TITLE = "BIT_ORDER_ITEMS";

    // =====================
    // SharePoint 헬퍼
    // =====================
    let spFormDigest = null;
    let spListItemEntityType = null;

    async function spFetch(path, options = {}) {
      const url = SP_SITE_RELATIVE_URL + path;
      const headers = Object.assign(
        { "Accept": "application/json;odata=verbose" },
        options.headers || {}
      );
      const res = await fetch(url, { ...options, headers });

      if (!res.ok) {
        const text = await res.text();
        console.error("SharePoint 요청 실패", res.status, text);
        throw new Error("SharePoint 요청 실패: " + res.status);
      }
      if (res.status === 204) return null;
      const json = await res.json();
      return json.d;
    }

    async function spEnsureDigest() {
      if (spFormDigest) return spFormDigest;
      const res = await fetch(SP_SITE_RELATIVE_URL + "/_api/contextinfo", {
        method: "POST",
        headers: { "Accept": "application/json;odata=verbose" }
      });
      const json = await res.json();
      spFormDigest = json.d.GetContextWebInformation.FormDigestValue;
      return spFormDigest;
    }

    async function spGetListItemEntityType() {
      if (spListItemEntityType) return spListItemEntityType;
      const d = await spFetch(
        "/_api/web/lists/getbytitle('" + SP_LIST_TITLE + "')?$select=ListItemEntityTypeFullName"
      );
      spListItemEntityType = d.ListItemEntityTypeFullName;
      return spListItemEntityType;
    }

    async function spLoadItems() {
      const d = await spFetch(
        "/_api/web/lists/getbytitle('" + SP_LIST_TITLE + "')/items" +
        "?$select=Id,Title,Category,Price,URL,Tags&$top=5000"
      );
      return d.results.map(row => ({
        id: row.Id,
        name: row.Title || "",
        category: row.Category || "",
        price: row.Price || 0,
        url: row.URL || "",
        tags: (row.Tags || "").split(/[,\s]+/).filter(Boolean)
      }));
    }

    async function spAddItem(item) {
      const digest = await spEnsureDigest();
      const typeName = await spGetListItemEntityType();
      const body = {
        "__metadata": { type: typeName },
        "Title": item.name,
        "Category": item.category,
        "Price": item.price,
        "URL": item.url,
        "Tags": item.tags.join(", ")
      };
      const d = await spFetch(
        "/_api/web/lists/getbytitle('" + SP_LIST_TITLE + "')/items",
        {
          method: "POST",
          headers: {
            "Content-Type": "application/json;odata=verbose",
            "X-RequestDigest": digest
          },
          body: JSON.stringify(body)
        }
      );
      return {
        id: d.Id,
        name: d.Title || "",
        category: d.Category || "",
        price: d.Price || 0,
        url: d.URL || "",
        tags: (d.Tags || "").split(/[,\s]+/).filter(Boolean)
      };
    }

    async function spUpdateItem(item) {
      const digest = await spEnsureDigest();
      const typeName = await spGetListItemEntityType();
      const body = {
        "__metadata": { type: typeName },
        "Title": item.name,
        "Category": item.category,
        "Price": item.price,
        "URL": item.url,
        "Tags": item.tags.join(", ")
      };
      await spFetch(
        "/_api/web/lists/getbytitle('" + SP_LIST_TITLE + "')/items(" + item.id + ")",
        {
          method: "POST",
          headers: {
            "Content-Type": "application/json;odata=verbose",
            "X-RequestDigest": digest,
            "IF-MATCH": "*",
            "X-HTTP-Method": "MERGE"
          },
          body: JSON.stringify(body)
        }
      );
    }

    async function spDeleteItem(id) {
      const digest = await spEnsureDigest();
      await spFetch(
        "/_api/web/lists/getbytitle('" + SP_LIST_TITLE + "')/items(" + id + ")",
        {
          method: "POST",
          headers: {
            "X-RequestDigest": digest,
            "IF-MATCH": "*",
            "X-HTTP-Method": "DELETE"
          }
        }
      );
    }

    // =====================
    // 앱 상태
    // =====================
    const FIXED_CATEGORIES = ["IT/장비", "사무용품", "소모품", "시설", "탕비류"];
    let items = [];
    let currentCategory = "ALL";
    let searchTerm = "";
    let sortOption = "default";
    let adminMode = false;
    let editingIndex = null;

    // DOM
    const categoryTabsEl = document.getElementById("categoryTabs");
    const itemsBodyEl = document.getElementById("itemsBody");
    const countInfoEl = document.getElementById("countInfo");
    const searchInput = document.getElementById("searchInput");
    const sortSelect = document.getElementById("sortSelect");
    const refreshBtn = document.getElementById("refreshBtn");
    const adminModeToggle = document.getElementById("adminModeToggle");
    const adminModeBadge = document.getElementById("adminModeBadge");
    const adminPanel = document.getElementById("adminPanel");
    const adminTitle = document.getElementById("adminTitle");
    const adminHint = document.getElementById("adminHint");
    const adminName = document.getElementById("adminName");
    const adminCategory = document.getElementById("adminCategory");
    const adminPrice = document.getElementById("adminPrice");
    const adminUrl = document.getElementById("adminUrl");
    const adminTags = document.getElementById("adminTags");
    const deleteBtn = document.getElementById("deleteBtn");
    const resetBtn = document.getElementById("resetBtn");
    const saveBtn = document.getElementById("saveBtn");
    const adminCloseBtn = document.getElementById("adminCloseBtn");

    // =====================
    // 렌더
    // =====================
    function renderCategories() {
      categoryTabsEl.innerHTML = "";

      const makeTab = (label, value) => {
        const btn = document.createElement("button");
        btn.className = "tab" + (currentCategory === value ? " active" : "");
        btn.textContent = label;
        btn.dataset.value = value;
        btn.addEventListener("click", () => {
          currentCategory = value;
          render();
        });
        categoryTabsEl.appendChild(btn);
      };

      makeTab("전체", "ALL");
      FIXED_CATEGORIES.forEach(cat => makeTab(cat, cat));
    }

    function applyFilters(data) {
      let out = data.slice();

      if (currentCategory !== "ALL") {
        out = out.filter(it => it.category === currentCategory);
      }

      if (searchTerm.trim()) {
        const q = searchTerm.trim().toLowerCase();
        out = out.filter(it => {
          const inName = it.name.toLowerCase().includes(q);
          const inTags = it.tags.join(" ").toLowerCase().includes(q);
          return inName || inTags;
        });
      }
      return out;
    }

    function applySort(data) {
      const out = data.slice();
      switch (sortOption) {
        case "nameAsc":
          out.sort((a, b) => a.name.localeCompare(b.name, "ko"));
          break;
        case "nameDesc":
          out.sort((a, b) => b.name.localeCompare(a.name, "ko"));
          break;
        case "priceAsc":
          out.sort((a, b) => (a.price || 0) - (b.price || 0));
          break;
        case "priceDesc":
          out.sort((a, b) => (b.price || 0) - (a.price || 0));
          break;
      }
      return out;
    }

    function formatPrice(v) {
      if (!v || isNaN(v)) return "-";
      return Number(v).toLocaleString("ko-KR");
    }

    function renderTable(data) {
      itemsBodyEl.innerHTML = "";
      if (!data.length) {
        const tr = document.createElement("tr");
        const td = document.createElement("td");
        td.colSpan = 5;
        td.style.textAlign = "center";
        td.style.padding = "18px 10px";
        td.style.color = "var(--text-muted)";
        td.textContent = "조건에 맞는 품목이 없습니다.";
        tr.appendChild(td);
        itemsBodyEl.appendChild(tr);
        return;
      }

      data.forEach((item, index) => {
        const tr = document.createElement("tr");

        const nameTd = document.createElement("td");
        const nameDiv = document.createElement("div");
        nameDiv.textContent = item.name || "-";
        nameDiv.style.fontSize = "13px";
        nameTd.appendChild(nameDiv);
        tr.appendChild(nameTd);

        const catTd = document.createElement("td");
        const catChip = document.createElement("span");
        catChip.className = "chip chip--accent";
        catChip.textContent = item.category || "-";
        catTd.appendChild(catChip);
        tr.appendChild(catTd);

        const tagsTd = document.createElement("td");
        if (item.tags && item.tags.length) {
          item.tags.forEach(tag => {
            const span = document.createElement("span");
            span.className = "chip-tag";
            span.textContent = tag;
            tagsTd.appendChild(span);
          });
        } else {
          tagsTd.style.color = "var(--text-muted)";
          tagsTd.textContent = "-";
        }
        tr.appendChild(tagsTd);

        const priceTd = document.createElement("td");
        priceTd.style.textAlign = "right";
        priceTd.className = "price";
        priceTd.textContent = formatPrice(item.price);
        tr.appendChild(priceTd);

        const linkTd = document.createElement("td");
        linkTd.style.textAlign = "center";
        const btn = document.createElement("button");
        btn.className = "link-btn";
        btn.textContent = "주문 페이지";
        btn.disabled = !item.url;
        btn.addEventListener("click", (ev) => {
          ev.stopPropagation();
          if (item.url) window.open(item.url, "_blank");
        });
        linkTd.appendChild(btn);
        tr.appendChild(linkTd);

        tr.addEventListener("click", () => {
          if (!adminMode) return;
          openEditor(index);
        });

        itemsBodyEl.appendChild(tr);
      });
    }

    function render() {
      const filtered = applyFilters(items);
      const sorted = applySort(filtered);
      renderTable(sorted);
      countInfoEl.textContent = `총 ${filtered.length}개 / 전체 ${items.length}개 항목`;
    }

    // =====================
    // 관리자 패널
    // =====================
    function clearEditor() {
      editingIndex = null;
      adminTitle.textContent = "새 품목 추가";
      adminHint.textContent = "SharePoint 리스트에 새 항목으로 추가됩니다.";
      adminName.value = "";
      adminCategory.value = "";
      adminPrice.value = "";
      adminUrl.value = "";
      adminTags.value = "";
      deleteBtn.style.display = "none";
    }

    function openEditor(index) {
      if (index == null) {
        clearEditor();
      } else {
        editingIndex = index;
        const item = items[index];
        adminTitle.textContent = "품목 수정";
        adminHint.textContent = `ID ${item.id} 항목을 수정합니다.`;
        adminName.value = item.name || "";
        adminCategory.value = item.category || "";
        adminPrice.value = item.price || "";
        adminUrl.value = item.url || "";
        adminTags.value = item.tags.join(", ");
        deleteBtn.style.display = "inline-flex";
      }
      adminPanel.classList.add("open");
    }

    function closeEditor() {
      adminPanel.classList.remove("open");
    }

    function parseTags(text) {
      return text.split(/[,\s]+/).map(t => t.trim()).filter(Boolean);
    }

    // =====================
    // 이벤트 바인딩
    // =====================
    async function loadItemsFromSharePoint() {
      try {
        const data = await spLoadItems();
        items = data;
        render();
      } catch (e) {
        console.error(e);
        alert("SharePoint에서 데이터를 불러오지 못했습니다.\n로그인 상태인지 확인하세요.");
      }
    }

    document.addEventListener("DOMContentLoaded", () => {
      renderCategories();
      loadItemsFromSharePoint();

      searchInput.addEventListener("input", (e) => {
        searchTerm = e.target.value;
        render();
      });

      sortSelect.addEventListener("change", (e) => {
        sortOption = e.target.value;
        render();
      });

      refreshBtn.addEventListener("click", () => {
        loadItemsFromSharePoint();
      });

      adminModeToggle.addEventListener("change", (e) => {
        adminMode = e.target.checked;
        adminModeBadge.textContent = adminMode ? "ON" : "OFF";
        adminModeBadge.className = adminMode ? "badge-on" : "badge-off";
        if (!adminMode) closeEditor();
      });

      adminCloseBtn.addEventListener("click", closeEditor);

      resetBtn.addEventListener("click", () => {
        if (editingIndex == null) clearEditor();
        else openEditor(editingIndex);
      });

      deleteBtn.addEventListener("click", async () => {
        if (editingIndex == null) return;
        const item = items[editingIndex];
        if (!confirm(`'${item.name}' 항목을 삭제하시겠습니까?`)) return;

        try {
          await spDeleteItem(item.id);
          items.splice(editingIndex, 1);
          render();
          closeEditor();
        } catch (e) {
          console.error(e);
          alert("삭제 중 오류가 발생했습니다.");
        }
      });

      saveBtn.addEventListener("click", async () => {
        const name = adminName.value.trim();
        const category = adminCategory.value;
        const price = Number(adminPrice.value || 0);
        const url = adminUrl.value.trim();
        const tags = parseTags(adminTags.value);

        if (!name) { alert("품명은 필수입니다."); return; }
        if (!category) { alert("카테고리를 선택하세요."); return; }

        const payload = { name, category, price, url, tags };

        try {
          if (editingIndex == null) {
            const created = await spAddItem(payload);
            items.push(created);
          } else {
            const base = items[editingIndex];
            const toSave = { ...base, ...payload };
            await spUpdateItem(toSave);
            items[editingIndex] = toSave;
          }
          render();
          closeEditor();
        } catch (e) {
          console.error(e);
          alert("저장 중 오류가 발생했습니다.");
        }
      });

      // 처음 관리자 모드 아닐 때는 패널 숨김
      clearEditor();
    });
  </script>
</body>
</html>






